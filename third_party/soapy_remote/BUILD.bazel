licenses(["notice"])

load("@bazel_skylib//lib:selects.bzl", "selects")

filegroup(
    name = "avahi_implementation",
    srcs = select(
        {
            "//platforms:macos_build": [
                "common/SoapyMDNSEndpointApple.cpp",
            ],
            "//conditions:default": [
                "common/SoapyMDNSEndpointAvahi.cpp",
            ],
        },
    ),
)

filegroup(
    name = "socket_defs_configuration",
    srcs = selects.with_or(
        {
            # Note: add other platforms as needed to this list. To add files for other platforms, use the patches
            # and similar sections of the http_archive() rule that brings in this package.
            ("//platforms:arm64_linux_build", "//platforms:arm7_linux_build", "//platforms:x86_64_linux_build"): [
                "common/SoapySocketDefs.linux.hpp",
            ],
        },
    ),
)

genrule(
    # Copy the platform-specific SoapySocketDefs.<platform>.hpp file to SoapySocketDefs.hpp.
    name = "SoapySocketDefs",
    srcs = [":socket_defs_configuration"],
    outs = ["common/SoapySocketDefs.hpp"],
    cmd_bash = "cp $< $@",
)

cc_library(
    name = "common",
    srcs = glob(
        ["common/**/*.cpp"],
        exclude = [
            "common/SoapyMDNSEndpointApple.cpp",
            "common/SoapyMDNSEndpointNone.cpp",
            "common/SoapyMDNSEndpointAvahi.cpp",
            "common/SoapyIfAddrsWindows.cpp",
        ],
    ) + [":avahi_implementation"],
    hdrs = glob(["common/**/*.hpp"]) + [":SoapySocketDefs"],
    strip_include_prefix = "common",
    visibility = ["//visibility:public"],
    deps = [
        "//third_party/avahi",
        "//third_party/soapysdr",
    ],
)

cc_library(
    name = "server",
    srcs = glob(
        ["server/**/*.cpp"],
        exclude = [
            "server/ThreadPrioWindows.cpp",
        ],
    ),
    hdrs = glob([
        "server/**/*.hpp",
        "server/**/*.h",
    ]),
    strip_include_prefix = "server",
    visibility = ["//visibility:public"],
    deps = [
        ":common",
        "//third_party/avahi",
        "//third_party/gflags",
        "//third_party/glog",
        "//third_party/soapysdr",
    ],
)
