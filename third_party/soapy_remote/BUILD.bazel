licenses(["notice"])

load("@rules_pkg//pkg:mappings.bzl", "pkg_attributes", "pkg_files")

filegroup(
    name = "avahi_implementation",
    srcs = select(
        {
            "@platforms//os:macos": [
                "common/SoapyMDNSEndpointApple.cpp",
            ],
            "//conditions:default": [
                "common/SoapyMDNSEndpointAvahi.cpp",
            ],
        },
    ),
)

filegroup(
    name = "socket_defs_configuration",
    srcs = select(
        {
            # Note: add other platforms as needed to this list. To add files for other platforms, use the patches
            # and similar sections of the http_archive() rule that brings in this package.
            "@platforms//os:linux": [
                "common/SoapySocketDefs.linux.hpp",
            ],
            "@platforms//os:macos": [
            ],
            "@platforms//os:windows": [
            ],
            "//conditions:default": [],
        },
    ),
)

genrule(
    # Copy the platform-specific SoapySocketDefs.<platform>.hpp file to SoapySocketDefs.hpp.
    name = "SoapySocketDefs",
    srcs = [":socket_defs_configuration"],
    outs = ["common/SoapySocketDefs.hpp"],
    cmd_bash = "cp $< $@",
)

cc_library(
    name = "common",
    srcs = glob(
        ["common/**/*.cpp"],
        exclude = [
            "common/SoapyMDNSEndpointApple.cpp",
            "common/SoapyMDNSEndpointNone.cpp",
            "common/SoapyMDNSEndpointAvahi.cpp",
            "common/SoapyIfAddrsWindows.cpp",
        ],
    ) + [":avahi_implementation"],
    hdrs = glob(["common/**/*.hpp"]) + [":SoapySocketDefs"],
    strip_include_prefix = "common",
    visibility = ["//visibility:public"],
    deps = [
        "//third_party/avahi",
        "//third_party/soapy",
    ],
)

cc_library(
    name = "server",
    srcs = glob(
        ["server/**/*.cpp"],
        exclude = [
            "server/ThreadPrioWindows.cpp",
        ],
    ),
    hdrs = glob([
        "server/**/*.hpp",
        "server/**/*.h",
    ]),
    strip_include_prefix = "server",
    visibility = ["//visibility:public"],
    deps = [
        ":common",
        "//third_party/avahi",
        "//third_party/soapy",
        "//third_party/gflags",
        "//third_party/glog",
    ],
)

cc_test(
    name = "soapy_remote_test",
    srcs = [
        "soapy_remote_test.cc",
    ],
    deps = [
        ":common",
        "//third_party/gtest",
    ],
)

pkg_files(
    name = "test_binaries",
    testonly = True,
    srcs = [
        ":soapy_remote_test",
    ],
    attributes = pkg_attributes(
        group = "tvsc",
        mode = "0555",
        owner = "tvsc",
    ),
    prefix = "bin",
    visibility = ["//visibility:public"],
)
