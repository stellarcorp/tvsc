<!DOCTYPE html>
<html>
  <head>
    <!-- TODO(james): Make these available from the local web server to allow for offline/disconnected use. -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.slim.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/protobufjs@7.1.2/dist/protobuf.js"></script>

    <style>
      * {
	  box-sizing: border-box;
      }

      body {
	  font-family: Verdana, Arial, Helvetica, sans-serif;
	  padding: 10px;
	  background: #f1f1f1;
      }

      .monospace {
	  font-family: "Lucida Console", Courier, monospace;
	  text-align: right;
      }

      h1 {
	  font-size: x-large;
	  font-weight: bolder;
      }

      h2 {
	  font-size: large;
	  font-weight: bolder;
      }

      .header {
	  padding: 10px;
	  text-align: center;
	  background: white;
      }

      .topnav {
	  overflow: hidden;
	  background-color: #333;
	  position: sticky;
	  position: -webkit-sticky;
	  top: 0px;
      }

      .topnav a {
	  float: left;
	  display: block;
	  color: #f0f0f0;
	  text-align: center;
	  padding: 14px 16px;
	  text-decoration: none;
      }

      .topnav a:hover {
	  background-color: #eee;
	  color: black;
      }

      .leftcolumn {
	  float: left;
	  width: 25%;
	  max-width: 300px;
      }

      .centercolumn {
	  float: left;
	  width: 75%;
	  padding-left: 20px;
      }

      .image {
	  background-color: #999;
	  width: 100%;
	  padding: 20px;
      }

      .panel_widget {
	  background-color: white;
	  padding: 20px;
	  margin-top: 20px;
	  width: 400px;
	  max-width: 100%;
	  height: 300px;
	  display: inline-grid;
      }

      .menu_widget {
	  background-color: white;
	  padding: 20px;
	  margin-top: 20px;
      }

      /* Clear any floats after the columns. */
      .row:after {
	  content: "";
	  display: table;
	  clear: both;
      }

      .footer {
	  padding: 15px;
	  text-align: center;
	  background: #666;
	  margin-top: 20px;
	  position: sticky;
	  position: -webkit-sticky;
	  bottom: 0px;
      }

      .copyright {
	  font-size: small;
	  color: black;
	  margin-top: 10px;
      }

      div.credits{display:none;}

      @media screen and (max-width: 800px) {
	  .leftcolumn, .centercolumn {
	      width: 100%;
	      padding: 0;
	      max-width: 800px;
	  }
      }

      /* Responsive layout - when the screen is less than 400px wide, make the navigation links stack on top of each other instead of next to each other */
      @media screen and (max-width: 400px) {
	  .topnav a {
	      float: none;
	      width: 100%;
	  }
      }
    </style>

    <script type = "text/javascript">
      var protos = {};
      protobuf.load("datetime.proto").then(function(root) {
	  protos["tvsc.service.datetime.DatetimeRequest"] = root.lookupType("tvsc.service.datetime.DatetimeRequest");
	  protos["tvsc.service.datetime.DatetimeReply"] = root.lookupType("tvsc.service.datetime.DatetimeReply");
      });
      protobuf.load("echo.proto").then(function(root) {
	  protos["tvsc.service.echo.EchoRequest"] = root.lookupType("tvsc.service.echo.EchoRequest");
	  protos["tvsc.service.echo.EchoReply"] = root.lookupType("tvsc.service.echo.EchoReply");
      });
      protobuf.load("radio.proto").then(function(root) {
	  protos["tvsc.service.radio.RadioListRequest"] = root.lookupType("tvsc.service.radio.RadioListRequest");
	  protos["tvsc.service.radio.Radio"] = root.lookupType("tvsc.service.radio.Radio");
	  protos["tvsc.service.radio.Radios"] = root.lookupType("tvsc.service.radio.Radios");
      });

      var web_sockets = {};
      var datetime_interval_id = -1;
      var current_date = new Date();

      function DecodeWsMessage(evt, proto_type) {
          var as_array = new Uint8Array(evt.data);
          var received_msg = protos[proto_type].decode(as_array);
	  return received_msg;
      }
      
      function GetProxyServerAddress() {
	  return location.hostname + ":50050";
      }

      function BuildWebSocketUrl(service, method) {
	  return "ws://" + GetProxyServerAddress() + "/service/" + service + "/" + method;
      }

      function CreateEchoSocket() {
	  var ws = new WebSocket(BuildWebSocketUrl("echo", "echo"));
	  ws.binaryType = "arraybuffer";

          ws.onmessage = function (evt) {
              var received_msg = DecodeWsMessage(evt, "tvsc.service.echo.EchoReply");
	      $("#echo_reply").text(received_msg.msg);
          };

	  return ws;
      }

      function ChangeDatetimeButtonToStop() {
	  $('#datetime_button').html("Pause")
	  $('#datetime_button').on('click.stop', function() {
	      StopDatetimeRequests();
	      $('#datetime_button').off('click.stop');
	  });
      }

      function ChangeDatetimeButtonToStart() {
	  $('#datetime_button').html("Resume")
	  $('#datetime_button').on('click.start', function() {
	      StartDatetimeRequests();
	      $('#datetime_button').off('click.start');
	  });
      }
      
      function StartDatetimeRequests() {
	  datetime_interval_id = window.setInterval(function(){
	      web_sockets["datetime"].send("");
	  }, 1);
	  ChangeDatetimeButtonToStop();
      }

      function StopDatetimeRequests() {
	  window.clearInterval(datetime_interval_id);
	  datetime_interval_id = -1;
	  ChangeDatetimeButtonToStart();
      }

      function CreateDatetimeSocket() {
	  var ws = new WebSocket(BuildWebSocketUrl("datetime", "get_datetime"));
	  ws.binaryType = "arraybuffer";

	  ws.onopen = function() {
	      StartDatetimeRequests();
	  };

          ws.onmessage = function (evt) {
              var as_array = new Uint8Array(evt.data);
              var received_msg = DecodeWsMessage(evt, "tvsc.service.datetime.DatetimeReply");
	      current_date.setTime(received_msg.datetime);
	      var date_text = current_date.toISOString();
	      $("#datetime_reply").text(date_text);
          };

	  ws.onclose = function() {
	      StopDatetimeRequests();
	  }

	  return ws;
      }

      function GetRadioList() {
	  web_sockets["radio/list_radios"].send("");
      }

      function CreateRadioListSocket() {
	  var ws = new WebSocket(BuildWebSocketUrl("radio", "list_radios"));
	  ws.binaryType = "arraybuffer";

          ws.onmessage = function (evt) {
              var radios = DecodeWsMessage(evt, "tvsc.service.radio.Radios");
	      $("#radio_list").empty();
	      console.log(radios.radios)
	      for (let radio of radios.radios) {
		  $('#radio_list').append($('<li>').text(radio.name))
	      }
          };

	  ws.onopen = function() {
	      GetRadioList();
	  };

	  return ws;
      }
      
      function CreateWebSockets() {
          if (!("WebSocket" in window)) {
	      // The browser doesn't support WebSocket
	      alert("WebSocket NOT supported by your Browser!");
	  } else {
              web_sockets["echo"] = CreateEchoSocket();
              web_sockets["datetime"] = CreateDatetimeSocket();
              web_sockets["radio/list_radios"] = CreateRadioListSocket();
	  }
      }

      function CallEcho(msg) {
	  web_sockets["echo"].send(msg);
      }
    </script>
  </head>

  <body onpageshow="CreateWebSockets()">

    <div class="header">
      <div style="text-align:right">
	<h1 class="monospace" id="callsign">KB2GSD</h1>
      </div>
    </div>

    <div class="topnav">
      <a href="#">Link 1</a>
      <a href="#">Link 2</a>
      <a href="#">Link 3</a>
      <a href="#" style="float:right">Other Link</a>
    </div>

    <div class="row">

      <div class="leftcolumn">
	<div class="menu_widget">
	  <h2>Radios</h2>
	  <ul id="radio_list">
	  </ul>
	</div>
      </div>

      <div class="centercolumn">
	<div class="panel_widget">
	  <h2>Echo Service</h2>
	  <form action="javascript:CallEcho($('#echo_message').val())">
	    <input type="text" id="echo_message" value=""/>
	    <input type="submit" value="Send"/>
	  </form>
	  <span id="echo_reply"></span>
	</div>

	<div class="panel_widget">
	  <h2>Time Service</h2>
	  <div>
	    <span id="datetime_reply"></span>
	    <button id="datetime_button"></button>
	  </div>
	</div>

      </div>

    </div>

    <div class="footer">
      <h2>Footer</h2>
      <span class="copyright">
	Copyright Â© 2022 Tennessee Valley Stellar Corporation. All Rights Reserved. Well, Some Rights Reserved. Maybe. It's complicated.
      </span>
    </div>

  </body>
</html>
